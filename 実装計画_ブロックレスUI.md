# ブロックレス UI 実装計画

## 概要

ブロックを意識しない自然な編集体験を実現するための UI/UX 改善計画

## 開発憲章準拠

- **単一責任の原則**: 各機能が明確な責務を持つ
- **関心の分離**: UI 操作とビジネスロジックの分離
- **設定とロジックの分離**: キーボードショートカット設定の外部化

## 実装目標

編集画面をそのままプレビュー画面になるくらいブロックを一切感じさせない自然な編集体験

## カーソル管理の基本方針

**常にどこかのブロックの中身にカーソルが入っている状態を基本とする**

### カーソル管理ルール

1. **新規段落作成時**: Enter 押下で新しい段落ブロック作成と同時に、そのブロック内にカーソルを移動
2. **エディタクリック時**: editor-content をクリックしたら、最も近いブロックの block-content 内にカーソルを移動
3. **キーボードナビゲーション**: 上下キーで上下のブロックの block-content 内にカーソルを移動
4. **フォーカス管理**: 常にどこかのブロック内にカーソルがある状態を維持
5. **ブロック削除時**: 削除されたブロックの前後のブロックのいずれかにカーソルを移動

### 技術実装方針

- 各ブロックコンポーネントで`useRef`を使用してテキストエリア/コンテンツエディタを管理
- グローバルなカーソル位置管理システムの構築
- キーボードイベントとマウスクリックイベントの統合
- ブロック間のフォーカス移動の自動化

## 機能仕様

### 1. キーボードナビゲーション

#### 1.1 ブロック間移動

- **↑↓ 矢印キー**: ブロック間のスムーズ移動 ✅
- **Home/End**: ブロック内の行頭/行末移動
- **Ctrl+↑↓**: ブロック間移動（矢印キーの代替）

#### 1.2 ブロック作成・編集

- **Enter**: 現在のブロック下に新しい段落ブロック作成 ✅
- **Shift+Enter**: 現在のブロック内で改行（`<br>`挿入）

#### 1.3 ブロックタイプ操作

- **Ctrl+Space**: ブロックタイプ切り替え ✅
  - 大見出し → 中見出し → 小見出し → 段落 → 大見出し
- **Shift+Space**: 強調表示切り替え ✅
  - normal → important → action-item → normal

#### 1.4 選択・編集操作

- **Ctrl+A**: 現在のブロック内の全選択（プレースホルダー）
- **Ctrl+Z**: ブロック単位でのアンドゥ ✅
- **Ctrl+Y**: ブロック単位でのリドゥ ✅

#### 1.5 検索・置換

- **Ctrl+F**: 全ブロック内検索（プレースホルダー）
- **Ctrl+H**: 全ブロック内置換（プレースホルダー）

### 2. 右クリックコンテキストメニュー

#### 2.1 メニュー項目

- **削除**: 現在のブロックを削除
- **テーブル**: 現在のブロック下にテーブル追加
- **画像**: 現在のブロック下に画像追加
- **水平線**: 現在のブロック下に水平線追加

#### 2.2 実装仕様

- ブロック上で右クリック時に表示
- メニュー外クリックで非表示
- キーボードショートカット対応

### 3. 自動ブロック管理

#### 3.1 空ブロック削除

- ブロック内容が空になった場合の自動削除
- フォーカス移動時に実行
- 最後のブロックは削除しない（最低 1 ブロック保持）

#### 3.2 HTML 最適化

- 同じ強調状態の段落が連続する場合の`<br>`結合
- HTML 出力時に実行
- 見出しブロックは結合しない

### 4. 視覚的改善

#### 4.1 ブロック選択強調の削除

- ブロック選択時の視覚的強調表示を削除
- カーソル位置のみで現在位置を表示

#### 4.2 カーソル位置の明確化

- 現在のブロックにカーソルを表示
- フォーカス状態の視覚的フィードバック
- ブロック境界の曖昧化

#### 4.3 自動フォーカス

- 新規ブロック作成時の自動フォーカス
- ブロック切り替え時のフォーカス保持

## 実装段階

### 第 1 段階: 基盤整備（高リスク）✅

**目標**: キーボードイベント処理の基盤構築
**期間**: 2-3 日
**完了日**: 2024 年 12 月

#### タスク

1. `useKeyboardNavigation` フック作成 ✅
2. キーボードイベント管理システム実装 ✅
3. ブロック間移動ロジック実装 ✅
4. イベント競合回避メカニズム ✅

#### 成果物

- キーボードイベント処理基盤 ✅
- ブロック間移動機能 ✅
- テストケース ✅

### 第 2 段階: 基本ナビゲーション（中リスク）✅

**目標**: 基本的なキーボードナビゲーション実装
**期間**: 2-3 日
**完了日**: 2024 年 12 月

#### タスク

1. 矢印キー移動実装 ✅
2. Enter 新規段落作成 ✅
3. Home/End 移動実装
4. フォーカス管理改善 ✅

#### 成果物

- 基本ナビゲーション機能 ✅
- フォーカス管理システム ✅

### 第 3 段階: ブロック操作（中リスク）

**目標**: ブロックタイプ・強調切り替え機能
**期間**: 2-3 日

#### タスク

1. Ctrl+Space ブロックタイプ切り替え ✅
2. Shift+Space 強調切り替え ✅
3. Ctrl+A 全選択機能
4. アンドゥ/リドゥ機能 ✅

#### 成果物

- ブロック操作機能 ✅
- アンドゥ/リドゥシステム ✅

### 第 4 段階: コンテキストメニュー（低リスク）

**目標**: 右クリックメニュー実装
**期間**: 1-2 日

#### タスク

1. 右クリックメニュー UI 実装
2. メニュー項目実装（削除、テーブル、画像、水平線）
3. キーボードショートカット対応

#### 成果物

- コンテキストメニュー機能

### 第 5 段階: 自動管理（中リスク）

**目標**: 空ブロック削除・HTML 最適化
**期間**: 2-3 日

#### タスク

1. 空ブロック自動削除機能
2. HTML 最適化（段落結合）
3. パフォーマンス最適化

#### 成果物

- 自動ブロック管理機能
- HTML 最適化機能

### 第 6 段階: 視覚改善（低リスク）

**目標**: ブロックレス感の実現
**期間**: 1-2 日

#### タスク

1. ブロック選択強調削除
2. カーソル位置明確化
3. 自動フォーカス機能
4. UI/UX 最終調整

#### 成果物

- ブロックレス UI
- 自然な編集体験

## 技術仕様

### キーボードイベント処理

```typescript
interface KeyboardNavigationConfig {
  enableArrowKeys: boolean;
  enableCtrlSpace: boolean;
  enableShiftSpace: boolean;
  enableContextMenu: boolean;
}
```

### ブロック管理

```typescript
interface BlockOperation {
  type: "create" | "update" | "delete" | "move";
  blockId: string;
  data?: any;
}
```

### アンドゥ/リドゥ

```typescript
interface UndoRedoState {
  blocks: Block[];
  cursorPosition: number;
  timestamp: number;
}
```

## テスト計画

### 単体テスト

- キーボードイベント処理
- ブロック操作ロジック
- アンドゥ/リドゥ機能

### 統合テスト

- キーボードナビゲーション
- コンテキストメニュー
- 自動ブロック管理

### ユーザビリティテスト

- 自然な編集体験の検証
- パフォーマンス測定
- アクセシビリティ確認

## リスク管理

### 高リスク項目

- キーボードイベント競合
- パフォーマンス劣化
- 既存機能への影響

### 対策

- 段階的実装による影響範囲限定
- 十分なテスト実施
- ロールバック計画の準備

## 成功指標

### 定量的指標

- キーボード操作の応答時間 < 100ms
- メモリ使用量の増加 < 20%
- バグ発生率 < 5%

### 定性的指標

- ブロックを意識しない自然な編集体験
- キーボード操作の直感性
- 視覚的なブロックレス感

## 完了条件

1. 全てのキーボードショートカットが正常動作
2. 右クリックメニューが正常動作
3. 空ブロック自動削除が正常動作
4. HTML 最適化が正常動作
5. ブロック選択強調が削除済み
6. カーソル位置が明確に表示
7. 自動フォーカスが正常動作
8. 全てのテストが通過
9. パフォーマンス要件を満たす
10. ユーザビリティ要件を満たす

## 修正履歴

### 2024 年 12 月 - エラー修正

- **BlockEditor.tsx**: `BulletListBlock`のインポートと`bulletList`ケースを削除
- **Sidebar.tsx**: `bulletList`タイプを削除
- **第 2 段階完了**: 基本ナビゲーション機能の実装完了
