/**
 * Teams会議情報取得用ブックマークレット
 * 
 * このファイルには、Microsoft Teamsの会議情報を自動取得するための
 * ブックマークレットコードが含まれています。
 */

/**
 * ブックマークレットの本体コード
 * 提供された最新版に更新（会議日時選択機能を含む）
 */
const bookmarkletCodeString = 'javascript:(function(){const wait=(ms)=>new Promise(res=>setTimeout(res,ms));const createProgressWindow=()=>{const overlay=document.createElement("div");overlay.id="meeting-progress-overlay";overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;justify-content:center;align-items:center;";const window=document.createElement("div");window.style.cssText="background:white;padding:20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);min-width:300px;text-align:center;font-family:Arial,sans-serif;";const title=document.createElement("h3");title.textContent="%E4%BC%9A%E8%AD%B0%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97%E4%B8%AD...";title.style.cssText="margin:0 0 15px 0;color:#333;";const status=document.createElement("div");status.id="progress-status";status.style.cssText="margin:10px 0;color:#666;font-size:14px;";const progress=document.createElement("div");progress.style.cssText="width:100%;height:6px;background:#f0f0f0;border-radius:3px;margin:15px 0;overflow:hidden;";const progressBar=document.createElement("div");progressBar.id="progress-bar";progressBar.style.cssText="width:0%;height:100%;background:linear-gradient(90deg,#4CAF50,#45a049);transition:width 0.3s ease;border-radius:3px;";progress.appendChild(progressBar);window.appendChild(title);window.appendChild(status);window.appendChild(progress);overlay.appendChild(window);document.body.appendChild(overlay);return{updateStatus:(text)=>{document.getElementById("progress-status").textContent=text;},updateProgress:(percent)=>{document.getElementById("progress-bar").style.width=percent+"%";},close:()=>{document.body.removeChild(overlay);}};};const createSelectionDialog=(options,optionElements)=>{return new Promise((resolve)=>{const overlay=document.createElement("div");overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;display:flex;justify-content:center;align-items:center;";const dialog=document.createElement("div");dialog.style.cssText="background:white;padding:20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);min-width:400px;max-width:600px;font-family:Arial,sans-serif;";const title=document.createElement("h3");title.textContent="%E4%BC%9A%E8%AD%B0%E6%97%A5%E6%99%82%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84";title.style.cssText="margin:0 0 15px 0;color:#333;text-align:center;";dialog.appendChild(title);const optionsContainer=document.createElement("div");optionsContainer.style.cssText="max-height:300px;overflow-y:auto;margin:15px 0;";options.forEach((option,index)=>{const optionDiv=document.createElement("div");optionDiv.style.cssText="padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:5px;cursor:pointer;transition:background-color 0.2s;";optionDiv.textContent=option;optionDiv.addEventListener("mouseenter",()=>{optionDiv.style.backgroundColor="#f0f0f0";});optionDiv.addEventListener("mouseleave",()=>{optionDiv.style.backgroundColor="white";});optionDiv.addEventListener("click",()=>{document.body.removeChild(overlay);const selectedElement=optionElements[index];if(selectedElement&&typeof selectedElement.click===\'function\'){selectedElement.click();}resolve(option);});optionsContainer.appendChild(optionDiv);});dialog.appendChild(optionsContainer);const cancelBtn=document.createElement("button");cancelBtn.textContent="%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB";cancelBtn.style.cssText="padding:8px 16px;background:#ccc;border:none;border-radius:5px;cursor:pointer;margin-top:10px;";cancelBtn.addEventListener("click",()=>{document.body.removeChild(overlay);const escEvent=new KeyboardEvent(\'keydown\',{key:\'Escape\',code:\'Escape\',keyCode:27,which:27,bubbles:true});document.dispatchEvent(escEvent);resolve(null);});dialog.appendChild(cancelBtn);overlay.appendChild(dialog);document.body.appendChild(overlay);});};const waitForElement=async(selector,maxWaitTime=20000)=>{const startTime=Date.now();while(Date.now()-startTime<maxWaitTime){const element=document.querySelector(selector);if(element){await wait(1000);return element;}await wait(1000);}throw new Error(selector+" %E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A7%E3%81%97%E3%81%9F");};const waitForElementOptional=async(selector,maxWaitTime=10000)=>{const startTime=Date.now();while(Date.now()-startTime<maxWaitTime){const element=document.querySelector(selector);if(element){await wait(1000);return element;}await wait(1000);}return null;};const getDateTimeFromRecapHeader=async()=>{await wait(2000);const recapHeader=document.querySelector(\'[data-tid="intelligent-recap-header"]\');if(!recapHeader){throw new Error("%E3%81%BE%E3%81%A8%E3%82%81%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93");}const dropdown=recapHeader.querySelector(\'[data-testid="intelligent-recap-instance-select-dropdown"]\');if(dropdown){const currentSelection=dropdown.querySelector(\'span\')?.innerText;if(currentSelection){dropdown.click();await wait(1000);const dropdownOptions=document.querySelectorAll(\'[role="option"]\');if(dropdownOptions.length>1){const options=Array.from(dropdownOptions).map(opt=>opt.innerText).filter(text=>text&&/\\d/.test(text));const optionElements=Array.from(dropdownOptions).filter((opt,index)=>{const text=opt.innerText;return text&&/\\d/.test(text);});if(options.length>1){const selectedDateTime=await createSelectionDialog(options,optionElements);await wait(5000);return selectedDateTime?[selectedDateTime]:[];}}const escEvent=new KeyboardEvent(\'keydown\',{key:\'Escape\',code:\'Escape\',keyCode:27,which:27,bubbles:true});document.dispatchEvent(escEvent);await wait(500);return[currentSelection];}}const singleSpan=recapHeader.querySelector(\'span\');if(singleSpan&&singleSpan.innerText&&/\\d/.test(singleSpan.innerText)){return[singleSpan.innerText];}return[];};const getAllParticipants=async(progressWindow)=>{progressWindow.updateStatus("%E5%8F%82%E5%8A%A0%E8%80%85%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...");let participants=[];const trackingView=document.querySelector(\'[data-tid="calv2-sf-tracking-view"]\');if(!trackingView){return[];}const showMoreBtn=document.querySelector(\'[data-tid="show-more-attendee-tracking-view"]\');if(showMoreBtn){progressWindow.updateStatus("%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E5%87%BA%E5%B8%AD%E8%80%85%E3%82%92%E8%A1%A8%E7%A4%BA%E4%B8%AD...");showMoreBtn.click();await wait(2000);}const personaElements=document.querySelectorAll(\'.ms-TooltipHost\');for(const element of personaElements){const name=element.innerText;if(name&&name.trim()&&!participants.includes(name.trim())){participants.push(name.trim());}}const allPersonaElements=document.querySelectorAll(\'[data-tid="CalendarPersonaPill"] .ms-Persona-primaryText .ms-TooltipHost\');for(const element of allPersonaElements){const name=element.innerText;if(name&&name.trim()&&!participants.includes(name.trim())){participants.push(name.trim());}}return participants.filter(name=>name.length>0);};const getTranscriptFromCurrentTab=async()=>{const c=await waitForElementOptional("[data-is-scrollable=\\"true\\"]");if(!c){return null;}let entries=[];let processedContent=new Set();const addEntries=(elements)=>{for(const e of elements){let s="%EF%BC%88%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%EF%BC%89",t="",msg="";const a=e.getAttribute("aria-label")||"";const m=a.match(/^(.+?)\\s+\\d/);if(m){s=m[1].trim();}else{const n=e.closest("[class*=\\"rightColumn-\\"]")?.querySelector("[class*=\\"itemDisplayName-\\"]");if(n)s=n.textContent.trim();}const tsEl=e.closest("[class*=\\"rightColumn-\\"]")?.querySelector("[id^=\\"Header-timestamp-\\"]");if(tsEl)t=tsEl.textContent.trim();const msgEl=e.querySelector("[id^=\\"sub-entry-\\"]");if(msgEl){msg=Array.from(msgEl.childNodes).filter(n=>n.nodeType===3).map(n=>n.textContent.trim()).join(" ");}if(!msg)continue;const uniqueKey=s+"|"+t+"|"+msg;if(processedContent.has(uniqueKey))continue;processedContent.add(uniqueKey);entries.push({speaker:s,time:t,content:msg});}};c.scrollTop=0;await wait(1000);addEntries(c.querySelectorAll("div[class*=\\"rightColumn-\\"]"));const totalHeight=c.scrollHeight;const viewHeight=c.clientHeight;const scrollStep=viewHeight*1.5;let currentScroll=0,loop=0;while(currentScroll<totalHeight&&loop<200){loop++;currentScroll+=scrollStep;c.scrollTop=currentScroll;await wait(300);if(Math.abs(c.scrollTop-currentScroll)>100){c.scrollTop=currentScroll;await wait(300);}addEntries(c.querySelectorAll("div[class*=\\"rightColumn-\\"]"));if(currentScroll>=totalHeight-viewHeight)break;}c.scrollTop=c.scrollHeight;await wait(2000);addEntries(c.querySelectorAll("div[class*=\\"rightColumn-\\"]"));entries.sort((a,b)=>{const timeA=a.time.split(":").reduce((acc,time)=>60*acc+parseInt(time,10),0);const timeB=b.time.split(":").reduce((acc,time)=>60*acc+parseInt(time,10),0);return timeA-timeB;});let transcript="";let lastSpeaker="";for(const entry of entries){if(entry.speaker==="%EF%BC%88%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%EF%BC%89"&&lastSpeaker){transcript+=entry.content+"\\n\\n";}else{if(entry.speaker!=="%EF%BC%88%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%EF%BC%89"){lastSpeaker=entry.speaker;}transcript+=entry.speaker+(entry.time?" ["+entry.time+"]":"")+":"+entry.content+"\\n\\n";}}return transcript||null;};const getAllTranscripts=async(progressWindow)=>{const tabList=document.querySelector(\'[data-tid="recap-tab-list"]\');if(!tabList){progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8E%A2%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99...");let transcriptBtn=await waitForElement("button[data-tid=\\"Transcript\\"]");transcriptBtn.click();progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%82%92%E9%96%8B%E3%81%8D%E3%81%BE%E3%81%97%E3%81%9F");await wait(3000);progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E5%86%85%E5%AE%B9%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E4%B8%AD...");const transcript=await getTranscriptFromCurrentTab();if(!transcript){throw new Error("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A7%E3%81%97%E3%81%9F");}return transcript;}const tabs=tabList.querySelectorAll(\'[role="tab"]\');if(tabs.length<=1){progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8E%A2%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99...");let transcriptBtn=await waitForElement("button[data-tid=\\"Transcript\\"]");transcriptBtn.click();progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%82%92%E9%96%8B%E3%81%8D%E3%81%BE%E3%81%97%E3%81%9F");await wait(3000);progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E5%86%85%E5%AE%B9%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E4%B8%AD...");const transcript=await getTranscriptFromCurrentTab();if(!transcript){throw new Error("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A7%E3%81%97%E3%81%9F");}return transcript;}else{let allTranscripts="";let hasAnyTranscript=false;progressWindow.updateStatus("%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%91%E3%83%BC%E3%83%88%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F ("+tabs.length+"%E5%80%8B)");for(let i=0;i<tabs.length;i++){const tab=tabs[i];const tabContent=tab.querySelector(\'.fui-Tab__content span\');const tabName=tabContent?.innerText||"%E3%83%91%E3%83%BC%E3%83%88 "+(i+1);progressWindow.updateStatus("%E3%83%91%E3%83%BC%E3%83%88 "+(i+1)+"/"+tabs.length+" ("+tabName+") %E3%82%92%E5%87%A6%E7%90%86%E4%B8%AD...");tab.click();await wait(3000);try{progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8E%A2%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99... ("+tabName+")");let transcriptBtn=await waitForElement("button[data-tid=\\"Transcript\\"]");transcriptBtn.click();progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%82%92%E9%96%8B%E3%81%8D%E3%81%BE%E3%81%97%E3%81%9F ("+tabName+")");await wait(3000);progressWindow.updateStatus("%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E5%86%85%E5%AE%B9%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E4%B8%AD... ("+tabName+")");const partTranscript=await getTranscriptFromCurrentTab();if(partTranscript){hasAnyTranscript=true;if(allTranscripts){allTranscripts+="\\n\\n=== "+tabName+" ===\\n\\n";}else{allTranscripts+"=== "+tabName+" ===\\n\\n";}allTranscripts+=partTranscript;}else{progressWindow.updateStatus("%E3%83%91%E3%83%BC%E3%83%88 "+tabName+" %E3%81%AB%E3%81%AF%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A7%E3%81%97%E3%81%9F");}}catch(e){progressWindow.updateStatus("%E3%83%91%E3%83%BC%E3%83%88 "+tabName+" %E3%81%AE%E5%87%A6%E7%90%86%E4%B8%AD%E3%81%AB%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F: "+e.message);}}if(!hasAnyTranscript){throw new Error("%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%91%E3%83%BC%E3%83%88%E3%81%A7%E6%96%87%E5%AD%97%E8%B5%B7%E3%81%93%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%A6%8B%E3%81%A4%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A7%E3%81%97%E3%81%9F");}return allTranscripts;}};(async()=>{const progressWindow=createProgressWindow();try{let cachedData=null;try{progressWindow.updateStatus("%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...");const clipboardText=await navigator.clipboard.readText();try{cachedData=JSON.parse(clipboardText);}catch(_){throw new Error("HTMLEditor%E3%81%8B%E3%82%89%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E7%94%BB%E9%9D%A2%E3%82%92%E9%96%8B%E3%81%84%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84");}if(typeof cachedData!=="object"){throw new Error("HTMLEditor%E3%81%8B%E3%82%89%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E7%94%BB%E9%9D%A2%E3%82%92%E9%96%8B%E3%81%84%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84");}progressWindow.updateStatus("%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89%E6%83%85%E5%A0%B1%E5%8F%96%E5%BE%97%E6%88%90%E5%8A%9F");progressWindow.updateProgress(5);}catch(e){progressWindow.close();alert("%E2%9D%8C "+e.message);return;}progressWindow.updateStatus("%E4%BC%9A%E8%AD%B0%E8%A9%B3%E7%B4%B0%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8E%A2%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99...");progressWindow.updateProgress(10);let detailBtn=await waitForElement("button[data-tid=\\"chat-meeting-details\\"]");detailBtn.click();progressWindow.updateStatus("%E4%BC%9A%E8%AD%B0%E8%A9%B3%E7%B4%B0%E3%82%92%E9%96%8B%E3%81%8D%E3%81%BE%E3%81%97%E3%81%9F");progressWindow.updateProgress(20);progressWindow.updateStatus("%E4%BC%9A%E8%AD%B0%E3%82%BF%E3%82%A4%E3%83%88%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...");await wait(2000);let titleEl=await waitForElement("span[data-tid=\\"calv2-sf-meeting-subject-view\\"]");let title=titleEl?.innerText||null;progressWindow.updateProgress(30);let participants=await getAllParticipants(progressWindow);progressWindow.updateProgress(40);progressWindow.updateStatus("%E3%81%BE%E3%81%A8%E3%82%81%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E6%8E%A2%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99...");let summaryBtn=await waitForElement("div[data-tid=\\"data-tid-%E3%81%BE%E3%81%A8%E3%82%81\\"]");summaryBtn.click();progressWindow.updateStatus("%E3%81%BE%E3%81%A8%E3%82%81%E3%82%92%E9%96%8B%E3%81%8D%E3%81%BE%E3%81%97%E3%81%9F");progressWindow.updateProgress(50);progressWindow.updateStatus("%E6%97%A5%E6%99%82%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...");let datetime=await getDateTimeFromRecapHeader();progressWindow.updateProgress(60);progressWindow.updateStatus("%E7%94%BB%E9%9D%A2%E3%81%AE%E6%9B%B4%E6%96%B0%E3%82%92%E5%BE%85%E6%A9%9F%E4%B8%AD...");await wait(2000);progressWindow.updateProgress(65);let transcript=await getAllTranscripts(progressWindow);progressWindow.updateProgress(95);progressWindow.updateStatus("%E7%B5%90%E6%9E%9C%E3%82%92%E5%87%A6%E7%90%86%E4%B8%AD...");let result={title,participants,datetime,transcript,Department:cachedData.Department,Issuer:cachedData.Issuer,typoCorrectionList:cachedData.typoCorrectionList};try{await navigator.clipboard.writeText(JSON.stringify(result,null,2));progressWindow.updateProgress(100);progressWindow.updateStatus("%E5%AE%8C%E4%BA%86%EF%BC%81");setTimeout(()=>{progressWindow.close();alert("%E2%9C%85 %E5%AE%8C%E4%BA%86%EF%BC%81%E4%BC%9A%E8%AD%B0%E6%83%85%E5%A0%B1%E3%81%A8%E8%AA%A4%E5%AD%97%E4%BF%AE%E6%AD%A3%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E5%8F%96%E5%BE%97%E3%81%97%E3%80%81%E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89%E3%81%AB%E3%82%B3%E3%83%94%E3%83%BC%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F");window.open("https://d3r0xupf0a2onu.cloudfront.net/use-case-builder/execute/7abad9ce-a83f-4ec6-91fe-4e843ec0add1","_blank");},1000);}catch(clipboardError){progressWindow.close();alert("%E2%9D%8C %E3%82%AF%E3%83%AA%E3%83%83%E3%83%97%E3%83%9C%E3%83%BC%E3%83%89%E3%82%B3%E3%83%94%E3%83%BC%E5%A4%B1%E6%95%97");}}catch(e){progressWindow.close();console.error("%E8%A9%B3%E7%B4%B0%E3%82%A8%E3%83%A9%E3%83%BC:",e);alert("%E2%9D%8C %E5%8F%96%E5%BE%97%E5%A4%B1%E6%95%97: "+(e.message||"unknown error"));}})().catch(e=>{console.error("%E2%9D%8C %E5%A4%96%E5%81%B4Promise%E3%82%A8%E3%83%A9%E3%83%BC:",e);});})();';

/**
 * ブックマークレットコードを取得する関数
 * @returns ブックマークレット用の完全なJavaScriptコード
 */
export const getBookmarkletCode = (): string => {
  return bookmarkletCodeString;
};

/**
 * ブックマークレットの表示名
 */
export const BOOKMARKLET_NAME = '会議情報取得ver05';

/**
 * ブックマークレットの説明
 */
export const BOOKMARKLET_DESCRIPTION = 'Microsoft Teamsの会議情報を自動取得し、HTMLEditorに送信するためのブックマークレットです。';