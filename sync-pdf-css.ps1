# PDF CSSåŒæœŸç”¨PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# é–‹ç™ºæ™‚ã«æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã‹ã€git ãƒ•ãƒƒã‚¯ã§è‡ªå‹•å®Ÿè¡Œå¯èƒ½

$frontendCss = ".\frontend\src\styles\pdf.css"
$backendCss = ".\backend\templates\pdf.css"
# also update TinyMCE public CSS so editor iframe picks up changes
$publicCss = ".\frontend\public\editor-styles.css"

Write-Host "PDF CSSåŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ" -ForegroundColor Cyan

# ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if (-not (Test-Path $frontendCss)) {
    Write-Host "âŒ ã‚¨ãƒ©ãƒ¼: ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $frontendCss" -ForegroundColor Red
    exit 1
}

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
$backendDir = Split-Path $backendCss -Parent
if (-not (Test-Path $backendDir)) {
    New-Item -ItemType Directory -Path $backendDir -Force | Out-Null
    Write-Host "ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ: $backendDir" -ForegroundColor Yellow
}

try {
    # CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    $cssContent = Get-Content $frontendCss -Raw -Encoding UTF8
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã§æ›¸ãè¾¼ã¿
    $header = @"
/* Copied from frontend/src/styles/pdf.css at sync time
   Backend will inline this CSS into the PDF template so wkhtmltopdf
   renders the same styles as the frontend TinyMCE preview.
   
   DO NOT EDIT THIS FILE DIRECTLY - EDIT frontend/src/styles/pdf.css INSTEAD
*/
"@
    
    $updatedContent = $header + "`n" + $cssContent
    # PowerShell 5.1å¯¾å¿œ: UTF8ã§BOMãªã—ã§ä¿å­˜ã™ã‚‹ãŸã‚[System.IO.File]ã‚’ä½¿ç”¨
    $utf8NoBom = New-Object System.Text.UTF8Encoding $false
    [System.IO.File]::WriteAllText($backendCss, $updatedContent, $utf8NoBom)

    # public/editor-styles.css ã‚‚æ›´æ–°ï¼ˆTinyMCEãŒå‚ç…§ï¼‰
    $publicDir = Split-Path $publicCss -Parent
    if (-not (Test-Path $publicDir)) {
        New-Item -ItemType Directory -Path $publicDir -Force | Out-Null
        Write-Host "ğŸ“ public ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ: $publicDir" -ForegroundColor Yellow
    }
    $publicHeader = @"
/* Copied from frontend/src/styles/pdf.css at sync time
   TinyMCE editor will load this CSS file to match PDF output styles.
   
   DO NOT EDIT THIS FILE DIRECTLY - EDIT frontend/src/styles/pdf.css INSTEAD
*/
"@
    $publicContent = $publicHeader + "`n" + $cssContent
    [System.IO.File]::WriteAllText($publicCss, $publicContent, $utf8NoBom)
    
    $sourceSize = (Get-Item $frontendCss).Length
    $targetSize = (Get-Item $backendCss).Length
    $publicSize = (Get-Item $publicCss).Length
    
    Write-Host "âœ… PDF CSSåŒæœŸå®Œäº†!" -ForegroundColor Green
    Write-Host "   ã‚½ãƒ¼ã‚¹: $frontendCss ($sourceSize bytes)" -ForegroundColor Gray
    Write-Host "   â†’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: $backendCss ($targetSize bytes)" -ForegroundColor Gray
    Write-Host "   â†’ TinyMCEç”¨: $publicCss ($publicSize bytes)" -ForegroundColor Gray
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ™‚åˆ»ã‚’ç¢ºèª
    $sourceTime = (Get-Item $frontendCss).LastWriteTime
    $targetTime = (Get-Item $backendCss).LastWriteTime
    $publicTime = (Get-Item $publicCss).LastWriteTime
    Write-Host "   ã‚½ãƒ¼ã‚¹æ›´æ–°: $($sourceTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Gray
    Write-Host "   ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ›´æ–°: $($targetTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Gray
    Write-Host "   TinyMCEç”¨æ›´æ–°: $($publicTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Gray
    
} catch {
    Write-Host "âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
